name: Montar vÃ­deo do Google Drive

on:
  workflow_dispatch:
    inputs:
      video_drive_id:
        description: 'ID do vÃ­deo principal no Google Drive'
        required: true
        type: string
      chave_json:
        description: 'Chave JSON da conta de serviÃ§o Google (JSON como string Ãºnica)'
        required: true
        type: string
      video_extra_1:
        description: 'ID do vÃ­deo extra 1 (opcional)'
        required: false
        type: string
      video_extra_2:
        description: 'ID do vÃ­deo extra 2 (opcional)'
        required: false
        type: string
      video_extra_3:
        description: 'ID do vÃ­deo extra 3 (opcional)'
        required: false
        type: string

jobs:
  montar-video:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ”½ Clonar repositÃ³rio
        uses: actions/checkout@v4

      - name: ðŸ§¾ Criar input.json com seguranÃ§a
        run: |
          printf '{
            "video_principal": "%s",
            "chave": %s,
            "videos_opcionais": [%s%s%s]
          }\n' \
          "${{ github.event.inputs.video_drive_id }}" \
          "${{ github.event.inputs.chave_json }}" \
          "${{ github.event.inputs.video_extra_1 && format('\"{0}\"', github.event.inputs.video_extra_1) || '' }}" \
          "${{ github.event.inputs.video_extra_2 && format(', \"{0}\"', github.event.inputs.video_extra_2) || '' }}" \
          "${{ github.event.inputs.video_extra_3 && format(', \"{0}\"', github.event.inputs.video_extra_3) || '' }}" \
          > input.json

      - name: ðŸ“‚ Mostrar conteÃºdo do input.json
        run: cat input.json

      - name: âš™ï¸ Instalar dependÃªncias
        run: |
          sudo apt update
          sudo apt install -y ffmpeg nodejs npm
          npm install googleapis

      - name: ðŸ” Gerar chave.json separada
        run: jq '.chave' input.json > chave.json

      - name: ðŸ§  Executar script unir.js
        run: node unir.js
        env:
          KEYFILE: chave.json
          INPUTFILE: input.json

      - name: ðŸ“¤ Upload do vÃ­deo final
        uses: actions/upload-artifact@v4
        with:
          name: video-final
          path: video_unido.mp4
